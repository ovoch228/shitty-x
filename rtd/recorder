if game.PlaceId ~= 124069847780670 then return end

local replicatedstorage = game:GetService("ReplicatedStorage")

local library = loadstring(game:HttpGet('https://raw.githubusercontent.com/ovoch228/depthsoimgui/refs/heads/main/library'))()

local bytenet = require(replicatedstorage.Teawork.Shared.Services.ByteNetworking)

local towers = bytenet.Towers
local mapinfo = replicatedstorage.RoundInfo

local ostime = os.time

getgenv().StratName = "Strat"

getgenv().timer = 0 -- seconds
getgenv().wave = mapinfo:GetAttribute("Wave")

getgenv().destroyui = false
getgenv().hooks = {}

local window = library:CreateWindow({
    Title = "Shitty X",
    Size = UDim2.new(0, 350, 0, 370),
    Position = UDim2.new(0.5, 0, 0, 70),
    NoResize = false
})

window:Center()

local filetab = window:CreateTab({
    Name = "Recorder",
    Visible = true
})

local filename = filetab:Label({
    Text = "StratName: " .. getgenv().StratName
})

local textbox = filetab:InputText({
    Label = "",
    PlaceHolder = "Enter Name: ",
    Callback = function(text)
        getgenv().StratName = text.Value
        filename:SetText("StratName: " .. text.Value)
    end
})

local writebutton = filetab:Button({
  	Text = "Write File",
    	Callback = function()
   		writefile(getgenv().StratName .. '.txt',
    			"local api = loadstring(game:HttpGet('https://raw.githubusercontent.com/ovoch228/shitty-x/refs/heads/main/rtd/api'))()\n\n" .. 
    			`api:Map('{mapinfo:GetAttribute("Map")}')\n` ..
    			"api:Start()\n\n" ..
    			"api:Loop(function()\n"
    		)
        	
        	getgenv().destroyui = true
 	end
})

while not destroyui do
    task.wait(0.1)
end

writebutton:Destroy()
textbox:Destroy()

task.wait(1)

local recordertab = filetab
local logstab = window:CreateTab({
    Name = "Logs",
    Visible = true
})

local loglabel = recordertab:Label({
    Label = "Last Log: Voting"
})

local row = logstab:Row()

logstab:Separator({
	Text = "Logs:"
})

local logs = logstab:Console({
	Text = "",
	ReadOnly = true,
	LineNumbers = false,
	Border = false,
	Fill = true,
	Enabled = true,
	AutoScroll = true,
	RichText = true,
	MaxLines = 200
})


function updatelog(text: string)
	setthreadidentity(7)
	logs:AppendText(DateTime.now():FormatLocalTime("HH:mm:ss", "en-us") .. ":", text)
	loglabel:SetText("Last Log: " .. text)
end

window:ShowTab(recordertab)
updatelog("Voting")

while #mapinfo:GetAttribute("Difficulty") == 0 do
  	task.wait(0.05)
end 

local lasttime = ostime()
task.spawn(function()
	while true do
		timer = (ostime() - lasttime) * 2
		task.wait(0.5)
	end	
end)


updatelog("Game Started")
appendfile(getgenv().StratName..".txt", `\t api:Difficulty('{mapinfo:GetAttribute("Difficulty")}')\n`)

mapinfo:GetAttributeChangedSignal("Wave"):Connect(function()
	wave = mapinfo:GetAttribute("Wave")
end)

-- Main Record Macros
bytenet.RoundResult.Show.listen(function() -- end screen
	updatelog("Macro Recorded!")
	--hooks = {}
	
	appendfile(getgenv().StratName..".txt", `\t api:PlayAgain() \n end)`)
end)

hooks["ready"] = hookfunction(bytenet.ReadyVote.Vote.send, function(value)
	updatelog("Sent ready vote")

	appendfile(getgenv().StratName..".txt", `\t api:Ready({timer}, {wave})\n`)	
	return hooks["ready"](value)
end)

hooks["skip"] = hookfunction(bytenet.SkipWave.Vote.send, function(value)
	updatelog("Skipped Wave " .. wave)

	appendfile(getgenv().StratName..".txt", `\t api:Skip({timer}, {wave})\n`)
	return hooks["skip"](value)
end)

hooks["autoskip"] = hookfunction(bytenet.SkipWave.ToggleAutoSkip.send, function(value)
	updatelog("AutoSkip set to: " .. tostring(value))

	appendfile(getgenv().StratName..".txt", `\t api:AutoSkip({value}, {timer}, {wave})\n`)
	return hooks["autoskip"](value)
end)

hooks["place"] = hookfunction(towers.PlaceTower.invoke, newcclosure(function(towerdata)	
	updatelog(`Placed Tower {towerdata.TowerID}`)

	appendfile(getgenv().StratName..".txt", `\t api:Place('{towerdata.TowerID}', Vector3.new({towerdata.Position}), {timer}, {wave})\n`)
	print("tower placed:", towerdata.TowerID, "pos:", towerdata.Position, Vector3.new(towerdata.Position), "time:", timer)
	return hooks["place"](towerdata)
end))

hooks["upgrade"] = hookfunction(towers.UpgradeTower.invoke, function(index)
	updatelog("Upgraded Tower " .. index)
	
	appendfile(getgenv().StratName..".txt", `\t api:Upgrade({index}, {timer}, {wave})\n`)
	print("tower upgrade:", index, typeof(index), "time", timer)
	return hooks["upgrade"](index)
end)

hooks["target"] = hookfunction(towers.SetTargetMode.send, function(towerdata)
	updatelog(`Changed Tower {towerdata.UID} Target to {towerdata.TargetMode} `)
	
	appendfile(getgenv().StratName..".txt", `\t api:SetTarget({towerdata.UID}, '{towerdata.TargetMode}', {timer}, {wave}) \n`)
	print("tower target:", towerdata.TargetMode, towerdata.UID, "time", timer)
	return hooks["target"](towerdata)
end)

hooks["sell"] = hookfunction(towers.SellTower.invoke, function(index)
	updatelog("Sold Tower " .. index)

	appendfile(getgenv().StratName..".txt", `\t api:Sell({index}, {timer}, {wave}) \n`)
	print("tower sold:", index, typeof(index))
	return hooks["sell"](index)
end)



